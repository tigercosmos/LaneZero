name: Multi-Platform Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-ubuntu:
    name: build_${{ matrix.os }}_${{ matrix.cmake_build_type }}

    runs-on: ${{ matrix.os }}

    env:
      QT_DEBUG_PLUGINS: 1
      QT_QPA_PLATFORM: offscreen

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04]
        cmake_build_type: [Release]
        python-version: ["3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies (Ubuntu)
        run: |
          sudo apt-get -qqy update
          sudo apt-get -qy install \
            sudo curl git build-essential make cmake libc6-dev gcc g++ \
            python3 python3-dev python3-venv

      - name: Add 8G swap (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.8.1"
          host: "linux"
          target: "desktop"
          arch: "linux_gcc_64"
          modules: "qt3d"
          setup-python: "false"
          cache: true

      - name: Install Python dependencies
        run: |
          python3 -m pip install setuptools
          python3 -m pip install pytest flake8 jsonschema
          python3 -m pip install pyside6==$(qmake6 -query QT_VERSION)

      - name: Show dependency
        run: |
          echo "gcc path: $(which gcc)"
          echo "gcc version: $(gcc --version)"
          echo "cmake path: $(which cmake)"
          echo "cmake version: $(cmake --version)"
          echo "python3 path: $(which python3)"
          echo "python3 version: $(python3 --version)"
          echo "pytest path: $(which pytest)"
          echo "pytest version: $(pytest --version)"
          echo "pyside6 path: $(python3 -c 'import PySide6; print(PySide6.__file__)')"

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-${{ matrix.cmake_build_type }}
          restore-keys: ${{ runner.os }}-${{ matrix.cmake_build_type }}
          create-symlink: true

      - name: Build and test with Qt OFF
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.cmake_build_type }} -DLANEZERO_USE_QT=OFF
          cmake --build . --config ${{ matrix.cmake_build_type }} -j4
          ctest --output-on-failure
          cd ..
          cp build/_core*.so LaneZero/ || true
          python3 -m pip install -e .
          python3 -m pytest test/ -v --ignore=test/test_viewer.py

      - name: Test examples without Qt
        run: |
          PYTHONPATH=. python3 examples/basic_simulation.py
          PYTHONPATH=. python3 examples/two_road_example.py

      - name: Build and test with Qt ON
        run: |
          rm -rf build
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.cmake_build_type }} -DLANEZERO_USE_QT=ON
          cmake --build . --config ${{ matrix.cmake_build_type }} -j4
          ctest --output-on-failure
          cd ..
          cp build/_core*.so LaneZero/ || true
          python3 -m pip install -e .
          python3 -m pytest test/ -v

  build-macos:
    name: build_${{ matrix.os }}_${{ matrix.cmake_build_type }}

    runs-on: ${{ matrix.os }}

    env:
      QT_DEBUG_PLUGINS: 1
      PIP_BREAK_SYSTEM_PACKAGES: 1

    strategy:
      fail-fast: false
      matrix:
        os: [macos-15]
        cmake_build_type: [Release]
        python-version: ["3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Create /usr/local/include
        run: |
          sudo mkdir -p /usr/local/include

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.8.1"
          host: "mac"
          target: "desktop"
          arch: "clang_64"
          modules: "qt3d"
          setup-python: "false"
          cache: true

      - name: Install Python dependencies
        run: |
          echo "which python3: $(which python3)"
          ls -al $(which python3)
          python3 -m pip -v install --upgrade setuptools
          python3 -m pip -v install --upgrade pytest flake8 jsonschema
          python3 -m pip -v install --upgrade pyside6==$(qmake -query QT_VERSION) --ignore-requires-python

      - name: Show dependency
        run: |
          echo "cmake path: $(which cmake)"
          echo "cmake version: $(cmake --version)"
          echo "python3 path: $(which python3)"
          echo "python3 version: $(python3 --version)"
          echo "pytest path: $(which pytest)"
          echo "pytest version: $(pytest --version)"

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-${{ matrix.cmake_build_type }}
          restore-keys: ${{ runner.os }}-${{ matrix.cmake_build_type }}
          create-symlink: true

      - name: Build and test with Qt OFF
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.cmake_build_type }} -DLANEZERO_USE_QT=OFF
          cmake --build . --config ${{ matrix.cmake_build_type }} -j4
          ctest --output-on-failure
          cd ..
          cp build/_core*.so LaneZero/ 2>/dev/null || cp build/_core*.dylib LaneZero/ 2>/dev/null || true
          python3 -m pip install -e .
          python3 -m pytest test/ -v --ignore=test/test_viewer.py

      - name: Test examples without Qt
        run: |
          PYTHONPATH=. python3 examples/basic_simulation.py
          PYTHONPATH=. python3 examples/two_road_example.py

      - name: Build and test with Qt ON
        run: |
          rm -rf build
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.cmake_build_type }} -DLANEZERO_USE_QT=ON
          cmake --build . --config ${{ matrix.cmake_build_type }} -j4
          ctest --output-on-failure
          cd ..
          cp build/_core*.so LaneZero/ 2>/dev/null || cp build/_core*.dylib LaneZero/ 2>/dev/null || true
          python3 -m pip install -e .
          PYSIDE6_PATH=$(python3 -c "import sys, os, PySide6; sys.stdout.write(os.path.dirname(PySide6.__file__))")
          echo "pyside6 path: ${PYSIDE6_PATH}"
          rm -rf ${PYSIDE6_PATH}/Qt/lib/*.framework 2>/dev/null || true
          QT_PREFIX=$(qmake -query QT_INSTALL_PREFIX)
          install_name_tool -add_rpath ${QT_PREFIX}/lib ${PYSIDE6_PATH}/QtWidgets.abi3.so 2>/dev/null || true
          install_name_tool -add_rpath ${QT_PREFIX}/lib ${PYSIDE6_PATH}/QtGui.abi3.so 2>/dev/null || true
          install_name_tool -add_rpath ${QT_PREFIX}/lib ${PYSIDE6_PATH}/QtCore.abi3.so 2>/dev/null || true
          python3 -m pytest test/ -v
